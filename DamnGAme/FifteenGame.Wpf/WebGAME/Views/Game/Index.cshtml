@{
    ViewData["Title"] = "Морской бой";
    var playerField = ViewBag.PlayerField as char[,];
    var computerField = ViewBag.ComputerField as char[,];
}

<h1>МОРСКОЙ БОЙ</h1>

<div style="display:flex; gap:50px; justify-content:center; margin-top:30px; font-family:Consolas;">

    <!-- Поле игрока -->
    <div>
        <h2>Твои корабли (осталось: @ViewBag.ComputerShipsLeft)</h2>
        <table border="1" style="border-collapse:collapse;">
            @for (int r = 0; r < 10; r++)
            {
                    <tr>
                    @for (int c = 0; c < 10; c++)
                    {
                        char cell = playerField[c, r];
                        string bg = cell == 'H' ? "red" :
                                    cell == 'M' ? "lightblue" :
                                    cell == 'S' ? "gray" : "white";
                        string symbol = cell == 'H' ? "✖" :
                                        cell == 'M' ? "•" :
                                        cell == 'S' ? "■" : "";
                            <td style="width:30px;height:30px;text-align:center;background:@bg">
                            @symbol
                            </td>
                    }
                    </tr>
            }
        </table>
    </div>

    <!-- Поле противника -->
    <div>
        <h2>Противник (осталось: @ViewBag.PlayerShipsLeft)</h2>
        <table border="1" style="border-collapse:collapse;" id="enemyTable">
            @for (int r = 0; r < 10; r++)
            {
                    <tr>
                    @for (int c = 0; c < 10; c++)
                    {
                        char cell = computerField[c, r];
                        string bg = cell == 'H' ? "red" :
                                    cell == 'M' ? "lightblue" : "white";
                        string symbol = cell == 'H' ? "✖" :
                                        cell == 'M' ? "•" : "";
                            <td style="width:30px;height:30px;text-align:center;background:@bg; cursor:pointer;"
                                onclick="shoot(@r, @c, this)">
                            @symbol
                            </td>
                    }
                    </tr>
            }
        </table>
    </div>

</div>

<form asp-action="Restart" method="post" style="text-align:center;margin-top:30px;">
    <button type="submit" style="padding:15px 30px;font-size:18px;">НОВАЯ ИГРА</button>
</form>

<script>
    async function shoot(row, col, cellElement) {
        if (cellElement.style.background === 'red' || cellElement.style.background === 'lightblue') return;

        const response = await fetch('/Game/Shoot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ row: row, column: col })
        });

        const result = await response.json();

        if (result.hit) {
            cellElement.style.background = 'red';
            cellElement.innerHTML = '✖';
            if (result.destroyed) setTimeout(()=>alert("ПОТОПИЛ!"),100);
        } else {
            cellElement.style.background = 'lightblue';
            cellElement.innerHTML = '•';
        }

        document.querySelector("h2:nth-of-type(2)").innerText =
            `Противник (осталось: ${result.playerShipsLeft})`;
        document.querySelector("h2:nth-of-type(1)").innerText =
            `Твои корабли (осталось: ${result.computerShipsLeft})`;

        if(result.playerWon){setTimeout(()=>{alert("ПОБЕДА!");location.reload();},500);}
        if(result.computerWon){setTimeout(()=>{alert("ПРОИГРАЛ!");location.reload();},500);}

        setTimeout(()=>location.reload(),1000); // обновить поле игрока
    }
</script>
