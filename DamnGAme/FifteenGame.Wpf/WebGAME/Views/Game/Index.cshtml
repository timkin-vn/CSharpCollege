@{
    ViewData["Title"] = "Морской бой";
    var playerField = ViewBag.PlayerField as FifteenGame.Business.Models.GameField;
    var computerField = ViewBag.ComputerField as FifteenGame.Business.Models.GameField;
}

<h1>МОРСКОЙ БОЙ</h1>

<div style="display:flex; gap:50px; justify-content:center; margin-top:30px; font-family:Consolas;">

    <!-- Твоё поле -->
    <div>
        <h2>Твои корабли (осталось: @ViewBag.ComputerShipsLeft)</h2>
        <table border="1" style="border-collapse:collapse;">
            @for (int r = 0; r < 10; r++)
            {
                    <tr>
                    @for (int c = 0; c < 10; c++)
                    {
                        char cell = playerField[r, c];
                        string bg = cell == 'H' ? "red" :
                                    cell == 'M' ? "lightblue" :
                                    cell == 'S' ? "gray" : "white";
                                <td style="width:30px;height:30px;text-align:center;background:@bg">
                            @(cell == 'S' ? "■" : cell == 'H' ? "✖" : cell == 'M' ? "•" : "")
                                </td>
                    }
                    </tr>
            }
        </table>
    </div>

    <!-- Поле противника -->
    <div>
        <h2>Противник (осталось: @ViewBag.PlayerShipsLeft)</h2>
        <table border="1" style="border-collapse:collapse;" id="enemyTable">
            @for (int r = 0; r < 10; r++)
            {
                    <tr>
                    @for (int c = 0; c < 10; c++)
                    {
                        char cell = computerField[r, c];
                        string bg = cell == 'H' ? "red" :
                                    cell == 'M' ? "lightblue" : "white";
                        string symbol = cell == 'H' ? "✖" : cell == 'M' ? "•" : "";
                                <td style="width:30px;height:30px;text-align:center;background:@bg;cursor:pointer;"
                                    onclick="shoot(@r, @c, this)">
                            @symbol
                                </td>
                    }
                    </tr>
            }
        </table>
    </div>

</div>

<form asp-action="Restart" method="post" style="text-align:center;margin-top:30px;">
    <button type="submit" style="padding:15px 30px;font-size:18px;">НОВАЯ ИГРА</button>
</form>

<script>
    async function shoot(row, col, cellElement) {
        // Защита от повторного клика
        if (cellElement.style.background === 'red' || cellElement.style.background === 'lightblue') {
            return;
        }

        const response = await fetch('/Game/Shoot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ row: row, column: col })
        });

        const result = await response.json();

        // Обновляем ячейку игрока
        if (result.hit) {
            cellElement.style.background = 'red';
            cellElement.innerHTML = '✖';
            if (result.destroyed) {
                alert('ПОТОПИЛ!');
            }
        } else {
            cellElement.style.background = 'lightblue';
            cellElement.innerHTML = '•';
        }

        // Обновляем счётчики
        document.querySelector('h2:nth-of-type(2)').innerText = `Противник (осталось: ${result.playerShipsLeft})`;

        // Проверяем победу
        if (result.playerWon) {
            alert('ТЫ ПОБЕДИЛ, СУКА!');
            location.reload();
        }
        if (result.computerWon) {
            alert('ПРОИГРАЛ, НУБ');
            location.reload();
        }

        // Обновляем своё поле (компьютер мог попасть)
        location.reload(); // Самое простое и надёжное решение
    }
</script>